<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Neon Panzer: Zone Warfare</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');
        
        body { 
            font-family: 'Cairo', sans-serif; 
            background-color: #000; 
            overflow: hidden; 
            touch-action: none; 
            user-select: none; 
            -webkit-user-select: none; 
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
        }
        
        #gameCanvas { 
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #050505; 
            display: block;
        }
        
        /* Neon Effects */
        .glass-panel { 
            background: rgba(15, 23, 42, 0.95); 
            backdrop-filter: blur(8px); 
            border: 1px solid rgba(56, 189, 248, 0.2); 
            box-shadow: 0 0 20px rgba(0,0,0,0.8); 
        }
        
        .neon-text { 
            text-shadow: 0 0 10px currentColor; 
        }
        
        .game-ui { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            pointer-events: none; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 20; 
        }
        
        .pointer-auto { pointer-events: auto; }

        /* HP Bar */
        .hp-segment { 
            width: 100%; 
            height: 100%; 
            background: #10b981; 
            transition: width 0.2s; 
            box-shadow: 0 0 10px #10b981; 
        }
        
        /* Floating Damage */
        @keyframes floatUp { 
            0% { transform: translateY(0) scale(0.8); opacity: 1; } 
            100% { transform: translateY(-40px) scale(1.2); opacity: 0; } 
        }
        
        .dmg-text { 
            position: absolute; 
            font-weight: 900; 
            pointer-events: none; 
            animation: floatUp 0.8s ease-out forwards; 
            text-shadow: 1px 1px 0 #000; 
            font-family: monospace; 
            z-index: 100;
        }

        /* Portal Animation */
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        .portal-ui { 
            width: 100px; 
            height: 100px; 
            border: 4px dashed #a855f7; 
            border-radius: 50%; 
            animation: spin 4s linear infinite; 
            position: absolute; 
            opacity: 0.5; 
            pointer-events: none; 
        }
        
        /* Arrow to portal */
        #portalArrow {
            position: absolute;
            width: 40px;
            height: 40px;
            color: #a855f7;
            font-size: 40px;
            text-align: center;
            line-height: 40px;
            pointer-events: none;
            z-index: 15;
            transition: transform 0.1s;
            filter: drop-shadow(0 0 10px #a855f7);
        }
        
        /* Hidden class */
        .hidden { display: none !important; }
        
        /* Loading overlay */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: #3b82f6;
            font-size: 1.5rem;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }
        
        /* Tank Selection */
        .tank-card {
            transition: all 0.3s;
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .tank-card:hover {
            transform: translateY(-5px);
            border-color: #3b82f6;
        }
        
        .tank-card.selected {
            border-color: #10b981;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
        }
        
        /* Zone Styles */
        .zone-marker {
            position: absolute;
            width: 100px;
            height: 100px;
            border: 3px dashed #fbbf24;
            border-radius: 50%;
            pointer-events: none;
            z-index: 5;
            opacity: 0.7;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.05); }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingOverlay" class="pointer-auto">
        <div class="loading-spinner"></div>
        <div>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©...</div>
        <div class="text-sm text-gray-400 mt-4">Ø¥Ø°Ø§ Ø§Ø³ØªÙ…Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ØŒ Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©</div>
    </div>

    <!-- Portal Arrow -->
    <div id="portalArrow" class="hidden">â†‘</div>

    <!-- HUD -->
    <div id="hud" class="hidden absolute inset-0 pointer-events-none z-10">
        <!-- Top Info -->
        <div class="absolute top-4 left-4 right-4 flex justify-between items-start">
            <div class="flex flex-col gap-1">
                <div class="glass-panel px-4 py-2 rounded-xl border-l-4 border-blue-500 flex items-center gap-3">
                    <span class="text-xs text-gray-400 font-bold">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</span>
                    <span id="zoneDisplay" class="text-blue-400 font-black text-2xl">1</span>
                    <div class="h-6 w-px bg-gray-700 mx-2"></div>
                    <span class="text-xs text-gray-400 font-bold">Ø§Ù„Ù…ÙˆØ¬Ø©</span>
                    <span id="waveDisplay" class="text-cyan-400 font-black text-2xl">1</span>
                </div>
                <div class="text-xs text-gray-500 mt-1" id="enemiesLeft">Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¡: 0</div>
                <div class="text-xs text-yellow-500" id="zoneProgress">Ø§Ù„ØªÙ‚Ø¯Ù…: 0%</div>
            </div>

            <div class="flex flex-col items-end gap-2">
                <div class="glass-panel px-4 py-1 rounded-full text-yellow-400 font-bold flex items-center gap-2">
                    <span id="goldDisplay">0</span> ğŸ’
                </div>
                <!-- Tank HP -->
                <div class="w-48 h-5 bg-gray-900 rounded border border-gray-700 relative overflow-hidden skew-x-[-10deg]">
                    <div id="hpBar" class="hp-segment"></div>
                </div>
                <!-- Tank Info -->
                <div class="text-xs text-gray-400" id="tankType">Ø¯Ø¨Ø§Ø¨Ø© Ø£Ø³Ø§Ø³ÙŠØ©</div>
            </div>
        </div>

        <!-- Ability Button -->
        <div id="abilityBtn" class="pointer-auto absolute bottom-12 right-8 w-20 h-20 rounded-full bg-blue-900/80 border-2 border-blue-400 flex items-center justify-center shadow-lg active:scale-95 transition-transform cursor-pointer">
            <span class="text-2xl">ğŸ›¡ï¸</span>
            <div id="abilityCd" class="absolute bottom-0 left-0 w-full bg-black/60 transition-all" style="height: 0%"></div>
        </div>
        
        <!-- Joystick Hint -->
        <div class="absolute bottom-20 left-12 w-24 h-24 border-2 border-dashed border-gray-700 rounded-full opacity-20 flex items-center justify-center">
            <div class="w-2 h-2 bg-gray-500 rounded-full"></div>
        </div>

        <!-- Mission Status -->
        <div id="missionStatus" class="hidden absolute top-24 left-1/2 transform -translate-x-1/2 glass-panel px-6 py-2 rounded-full text-green-400 font-bold animate-pulse border border-green-500/50">
            âœ… ØªÙ… ØªØ·Ù‡ÙŠØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©! Ø§ØªØ¬Ù‡ Ù„Ù„Ø¨ÙˆØ§Ø¨Ø©
        </div>
        
        <!-- Zone Warning -->
        <div id="zoneWarning" class="hidden absolute top-36 left-1/2 transform -translate-x-1/2 glass-panel px-6 py-2 rounded-full text-yellow-400 font-bold border border-yellow-500/50">
            âš¡ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø³ØªÙ†ØªÙ‡ÙŠ Ù‚Ø±ÙŠØ¨Ø§Ù‹!
        </div>
    </div>

    <!-- Main Menu -->
    <div id="mainMenu" class="game-ui z-40 bg-[#020203] pointer-auto flex-col overflow-y-auto">
        <div class="w-full max-w-md p-6 flex flex-col items-center min-h-screen pt-12">
            <h1 class="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-b from-blue-400 to-indigo-600 mb-2 neon-text">PANZER</h1>
            <h2 class="text-2xl font-bold text-gray-500 mb-8 tracking-[0.5em]">ZONE WARFARE</h2>
            
            <div class="glass-panel w-full p-5 rounded-2xl mb-8 flex justify-between items-center relative overflow-hidden">
                <div class="absolute top-0 left-0 w-1 h-full bg-yellow-500"></div>
                <div>
                    <div class="text-gray-400 text-xs uppercase mb-1">Ø®Ø²ÙŠÙ†Ø© Ø§Ù„Ø­Ø±Ø¨</div>
                    <div class="text-yellow-400 font-black text-4xl" id="menuGold">0</div>
                </div>
                <div class="text-5xl">ğŸ’</div>
            </div>
            
            <!-- Tank Selection -->
            <div class="glass-panel w-full p-4 rounded-xl mb-6">
                <div class="text-lg font-bold text-white mb-3 text-center">Ø§Ø®ØªØ± Ø¯Ø¨Ø§Ø¨ØªÙƒ</div>
                <div class="grid grid-cols-2 gap-3" id="tankSelection">
                    <!-- Tanks will be loaded here -->
                </div>
            </div>

            <div class="w-full grid gap-4 z-10">
                <button id="btnStart" class="bg-blue-600 hover:bg-blue-500 text-white font-black py-5 rounded-xl text-xl shadow-[0_0_20px_rgba(37,99,235,0.4)] transition-all active:scale-95 cursor-pointer">
                    Ø¥Ù†ØªØ´Ø§Ø± ÙÙŠ Ø§Ù„Ù…ÙŠØ¯Ø§Ù†
                </button>
                <div class="grid grid-cols-3 gap-4">
                    <button id="btnUpgrade" class="glass-panel hover:bg-white/5 text-white font-bold py-4 rounded-xl active:scale-95 flex flex-col items-center gap-2 cursor-pointer">
                        <span class="text-2xl">ğŸ”§</span> <span>Ø§Ù„ÙˆØ±Ø´Ø©</span>
                    </button>
                    <button id="btnTanks" class="glass-panel hover:bg-white/5 text-white font-bold py-4 rounded-xl active:scale-95 flex flex-col items-center gap-2 cursor-pointer">
                        <span class="text-2xl">âš™ï¸</span> <span>Ø§Ù„Ø¯Ø¨Ø§Ø¨Ø§Øª</span>
                    </button>
                    <button id="btnAllies" class="glass-panel hover:bg-white/5 text-white font-bold py-4 rounded-xl active:scale-95 flex flex-col items-center gap-2 cursor-pointer">
                        <span class="text-2xl">ğŸ¤–</span> <span>Ø§Ù„Ø­Ù„ÙØ§Ø¡</span>
                    </button>
                </div>
            </div>
            
            <button id="btnReset" class="mt-8 text-xs text-red-900 hover:text-red-500 cursor-pointer">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </div>
    </div>

    <!-- Tank Selection Screen -->
    <div id="tankScreen" class="game-ui hidden z-50 bg-[#050508] pointer-auto flex-col">
        <div class="w-full max-w-md p-4 h-full flex flex-col">
            <div class="flex justify-between items-center mb-6 py-4 border-b border-gray-800">
                <h2 class="text-2xl font-bold text-white">âš™ï¸ Ù…Ø¹Ø±Ø¶ Ø§Ù„Ø¯Ø¨Ø§Ø¨Ø§Øª</h2>
                <div class="text-yellow-400 font-bold" id="tankGoldDisplay">0 ğŸ’</div>
            </div>
            <div id="tankList" class="space-y-4 overflow-y-auto flex-1 pb-20">
                <!-- Tank cards will be loaded here -->
            </div>
            <button id="btnBackToMenuFromTanks" class="w-full bg-gray-800 text-white font-bold py-4 rounded-xl mt-4 cursor-pointer">Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¹Ø¯Ø©</button>
        </div>
    </div>

    <!-- Upgrade Workshop -->
    <div id="shopScreen" class="game-ui hidden z-50 bg-[#050508] pointer-auto flex-col">
        <div class="w-full max-w-md p-4 h-full flex flex-col">
            <div class="flex justify-between items-center mb-6 py-4 border-b border-gray-800">
                <h2 class="text-2xl font-bold text-white">ğŸ”§ ÙˆØ±Ø´Ø© Ø§Ù„Ø¯Ø¨Ø§Ø¨Ø§Øª</h2>
                <div class="text-yellow-400 font-bold" id="shopGoldDisplay">0 ğŸ’</div>
            </div>
            <div id="shopList" class="space-y-3 overflow-y-auto flex-1 pb-20"></div>
            <button id="btnBackToMenu" class="w-full bg-gray-800 text-white font-bold py-4 rounded-xl mt-4 cursor-pointer">Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¹Ø¯Ø©</button>
        </div>
    </div>

    <!-- Game Over -->
    <div id="gameOverScreen" class="game-ui hidden z-50 bg-black/95 pointer-auto flex-col">
        <h2 class="text-6xl font-black text-red-600 mb-2 neon-text">Ø¯ÙÙ…Ø±Øª</h2>
        <p class="text-gray-400 text-lg mb-8">ØªÙ… ØªØ¯Ù…ÙŠØ± Ø§Ù„Ø¯Ø¨Ø§Ø¨Ø© ÙÙŠ Ø§Ù„Ù…Ø¹Ø±ÙƒØ©</p>
        
        <div class="glass-panel p-6 rounded-2xl w-64 text-center mb-8 border-t-4 border-red-600">
            <div class="text-xs text-gray-500 uppercase mb-2">ÙˆØµÙ„Øª Ù„Ù„Ù…Ù†Ø·Ù‚Ø©</div>
            <div class="text-white text-4xl font-black mb-4" id="endZone">1</div>
            <div class="border-t border-gray-700 pt-4 flex justify-between px-4">
                <span class="text-gray-400">ØºÙ†Ø§Ø¦Ù…:</span>
                <span class="text-yellow-400 font-bold" id="endGold">0</span>
            </div>
        </div>

        <button id="btnRestart" class="bg-white text-black font-black py-4 px-12 rounded-full hover:scale-105 transition-transform mb-4 cursor-pointer">
            Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ù†ØªØ´Ø§Ø±
        </button>
        <button id="btnToMenu" class="text-gray-500 underline cursor-pointer">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
        window.__app_id = 'neon-panzer-zone';
        window.__firebase_config = '{}';
    </script>

    <script type="module">
        // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© ---
        
        // Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¯Ø¨Ø§Ø¨Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
        const TANK_TYPES = {
            basic: {
                name: 'Ø¯Ø¨Ø§Ø¨Ø© Ø£Ø³Ø§Ø³ÙŠØ©',
                desc: 'Ø¯Ø¨Ø§Ø¨Ø© Ù…ØªÙˆØ§Ø²Ù†Ø© Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ù…Ø¨ØªØ¯Ø¦ÙŠÙ†',
                color: '#22d3ee',
                speed: 3,
                hp: 100,
                damage: 10,
                rate: 20,
                cost: 0,
                unlocked: true,
                special: 'Ø¨Ø¯ÙˆÙ† Ù‚Ø¯Ø±Ø© Ø®Ø§ØµØ©'
            },
            assault: {
                name: 'Ø¯Ø¨Ø§Ø¨Ø© Ø§Ù‚ØªØ­Ø§Ù…',
                desc: 'Ø³Ø±Ø¹Ø© Ø¹Ø§Ù„ÙŠØ© Ù…Ø¹ Ø¥Ø·Ù„Ø§Ù‚ Ù†Ø§Ø± Ø³Ø±ÙŠØ¹',
                color: '#3b82f6',
                speed: 3.5,
                hp: 80,
                damage: 8,
                rate: 15,
                cost: 500,
                unlocked: false,
                special: '+20% Ø³Ø±Ø¹Ø©'
            },
            heavy: {
                name: 'Ø¯Ø¨Ø§Ø¨Ø© Ø«Ù‚ÙŠÙ„Ø©',
                desc: 'Ø¯Ø±Ø¹ Ø³Ù…ÙŠÙƒ Ù…Ø¹ Ø¶Ø±Ø± Ø¹Ø§Ù„ÙŠ',
                color: '#ef4444',
                speed: 2.2,
                hp: 150,
                damage: 15,
                rate: 25,
                cost: 1000,
                unlocked: false,
                special: '+50% ØµØ­Ø©'
            },
            sniper: {
                name: 'Ø¯Ø¨Ø§Ø¨Ø© Ù‚Ù†Ø§Øµ',
                desc: 'Ù…Ø¯Ù‰ Ø·ÙˆÙŠÙ„ Ù…Ø¹ Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©',
                color: '#10b981',
                speed: 2.8,
                hp: 90,
                damage: 25,
                rate: 40,
                cost: 1500,
                unlocked: false,
                special: 'Ù…Ø¯Ù‰ +30%'
            },
            tank: {
                name: 'Ø¯Ø¨Ø§Ø¨Ø© Ø­Ø±Ø¨ÙŠØ©',
                desc: 'Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ø§Øª Ù…Ø¹ Ù‚Ø¯Ø±Ø§Øª Ø¯ÙØ§Ø¹ÙŠØ©',
                color: '#8b5cf6',
                speed: 2.5,
                hp: 120,
                damage: 12,
                rate: 22,
                cost: 2000,
                unlocked: false,
                special: 'Ø¯Ø±Ø¹ Ù…ØªØ·ÙˆØ±'
            },
            elite: {
                name: 'Ø¯Ø¨Ø§Ø¨Ø© Ø§Ù„Ù†Ø®Ø¨Ø©',
                desc: 'Ø§Ù„Ø¯Ø¨Ø§Ø¨Ø© Ø§Ù„Ø£Ù‚ÙˆÙ‰ Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ù…ÙƒØ§Ù†ÙŠØ§Øª',
                color: '#fbbf24',
                speed: 3.2,
                hp: 130,
                damage: 18,
                rate: 18,
                cost: 5000,
                unlocked: false,
                special: 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø²Ø§ÙŠØ§'
            }
        };

        // Ø§Ù„ØªØ·ÙˆÙŠØ±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
        const UPGRADES = {
            damage: { 
                name: 'Ù…Ø¯ÙØ¹ Ø¨Ù„Ø§Ø²Ù…Ø§', 
                desc: 'Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¶Ø±Ø± +15% Ù„ÙƒÙ„ Ù…Ø³ØªÙˆÙ‰', 
                max: 20, 
                cost: l => (l+1)*100, 
                val: l => l * 0.15,
                category: 'attack'
            },
            health: { 
                name: 'Ø¯Ø±Ø¹ Ù…Ø±ÙƒØ¨', 
                desc: 'Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ØµØ­Ø© +25 Ù„ÙƒÙ„ Ù…Ø³ØªÙˆÙ‰', 
                max: 20, 
                cost: l => (l+1)*100, 
                val: l => l * 25,
                category: 'defense'
            },
            speed:  { 
                name: 'Ù…Ø­Ø±Ùƒ ØªÙŠØ±Ø¨Ùˆ', 
                desc: 'Ø³Ø±Ø¹Ø© Ø§Ù„Ø­Ø±ÙƒØ© +8% Ù„ÙƒÙ„ Ù…Ø³ØªÙˆÙ‰', 
                max: 10, 
                cost: l => (l+1)*150, 
                val: l => l * 0.08,
                category: 'mobility'
            },
            rate:   { 
                name: 'Ù…Ù„Ù‚Ù… Ø¢Ù„ÙŠ', 
                desc: 'Ø³Ø±Ø¹Ø© Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ +10% Ù„ÙƒÙ„ Ù…Ø³ØªÙˆÙ‰', 
                max: 10, 
                cost: l => (l+1)*200, 
                val: l => l * 0.1,
                category: 'attack'
            },
            ally:   { 
                name: 'Ø¯Ø±ÙˆÙ† Ù…Ø³Ø§Ù†Ø¯', 
                desc: 'Ø´Ø±Ø§Ø¡ Ø­Ù„ÙŠÙ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 3)', 
                max: 3, 
                cost: l => (l+1)*1000, 
                val: l => l,
                category: 'support'
            },
            range: {
                name: 'Ù†Ø¸Ø§Ù… ØªØµÙˆÙŠØ¨',
                desc: 'Ø²ÙŠØ§Ø¯Ø© Ù…Ø¯Ù‰ Ø§Ù„Ø±Ù…Ø§ÙŠØ© +10% Ù„ÙƒÙ„ Ù…Ø³ØªÙˆÙ‰',
                max: 10,
                cost: l => (l+1)*180,
                val: l => l * 0.1,
                category: 'attack'
            },
            regen: {
                name: 'Ø¥ØµÙ„Ø§Ø­ ØªÙ„Ù‚Ø§Ø¦ÙŠ',
                desc: 'Ø§Ø³ØªØ¹Ø§Ø¯Ø© 1% Ù…Ù† Ø§Ù„ØµØ­Ø© ÙƒÙ„ 10 Ø«ÙˆØ§Ù†',
                max: 5,
                cost: l => (l+1)*300,
                val: l => l * 0.01,
                category: 'defense'
            },
            critical: {
                name: 'Ø¶Ø±Ø¨Ø§Øª Ø­Ø±Ø¬Ø©',
                desc: 'ÙØ±ØµØ© Ø¶Ø±Ø¨Ø© Ø­Ø±Ø¬Ø© +5% Ù„ÙƒÙ„ Ù…Ø³ØªÙˆÙ‰',
                max: 5,
                cost: l => (l+1)*250,
                val: l => l * 0.05,
                category: 'attack'
            }
        };

        // --- Ù…Ø­Ø±Ùƒ Ø§Ù„Ù„Ø¹Ø¨Ø© ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let W = canvas.width = window.innerWidth;
        let H = canvas.height = window.innerHeight;

        let Game = {
            state: 'MENU',
            data: { 
                gold: 0, 
                upgrades: { 
                    damage: 0, 
                    health: 0, 
                    speed: 0, 
                    rate: 0, 
                    ally: 0,
                    range: 0,
                    regen: 0,
                    critical: 0
                },
                unlockedTanks: ['basic'],
                selectedTank: 'basic'
            },
            
            // ÙˆÙ‚Øª Ø§Ù„ØªØ´ØºÙŠÙ„
            currentZone: 1,
            currentWave: 1,
            zoneEnemies: 0,
            enemiesDefeated: 0,
            runGold: 0,
            portalOpen: false,
            
            // Ø§Ù„ÙƒØ§Ø¦Ù†Ø§Øª
            player: null,
            allies: [],
            enemies: [],
            walls: [],
            grass: [],
            zoneMarkers: [],
            bullets: [],
            particles: [],
            texts: [],
            portal: null,
            
            camera: { x: 0, y: 0, shake: 0 },
            input: { active: false, x: 0, y: 0, px: 0, py: 0 },
            
            // Ø§Ù„Ù…Ø¤Ù‚ØªØ§Øª
            lastRegen: 0,
            gameTime: 0
        };

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙˆØª ---
        let Audio = {
            synth: null,
            init: async () => {
                if(Audio.synth) return;
                try {
                    await Tone.start();
                    Audio.synth = new Tone.PolySynth(Tone.Synth).toDestination();
                    Audio.synth.volume.value = -12;
                    Audio.bass = new Tone.MembraneSynth().toDestination();
                    Audio.bass.volume.value = -8;
                } catch (error) {
                    console.log("Audio initialization failed, continuing without audio");
                }
            },
            play: (id) => {
                if(!Audio.synth) return;
                if(id=='shoot') Audio.synth.triggerAttackRelease("C4", "32n", undefined, 0.1);
                if(id=='hit') Audio.synth.triggerAttackRelease("G2", "16n", undefined, 0.1);
                if(id=='kill') Audio.bass.triggerAttackRelease("C1", "8n");
                if(id=='coin') Audio.synth.triggerAttackRelease("E6", "32n", undefined, 0.05);
                if(id=='portal') Audio.synth.triggerAttackRelease(["C4","E4","G4"], "4n");
                if(id=='upgrade') Audio.synth.triggerAttackRelease(["C5","E5","G5"], "8n");
            }
        };

        // --- ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ ÙˆØ§Ù„Ù…ÙˆØ¬Ø§Øª ---
        function generateZone(zone) {
            const zoneSize = 2000 + (zone * 300);
            const zoneType = zone % 5; // 5 Ø£Ù†ÙˆØ§Ø¹ Ù…Ø®ØªÙ„ÙØ© Ù…Ù† Ø§Ù„Ù…Ù†Ø§Ø·Ù‚
            
            Game.walls = [];
            Game.grass = [];
            Game.zoneMarkers = [];
            
            // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©
            let zoneColor, zoneTheme;
            switch(zoneType) {
                case 0: // Ù…Ù†Ø·Ù‚Ø© ØµØ­Ø±Ø§ÙˆÙŠØ©
                    zoneColor = '#d97706';
                    zoneTheme = 'ØµØ­Ø±Ø§Ø¡';
                    break;
                case 1: // Ù…Ù†Ø·Ù‚Ø© Ø­Ø¶Ø±ÙŠØ©
                    zoneColor = '#4b5563';
                    zoneTheme = 'Ù…Ø¯ÙŠÙ†Ø©';
                    break;
                case 2: // Ù…Ù†Ø·Ù‚Ø© ØºØ§Ø¨Ø§Øª
                    zoneColor = '#065f46';
                    zoneTheme = 'ØºØ§Ø¨Ø©';
                    break;
                case 3: // Ù…Ù†Ø·Ù‚Ø© Ø¬Ù„ÙŠØ¯ÙŠØ©
                    zoneColor = '#0ea5e9';
                    zoneTheme = 'Ø¬Ù„ÙŠØ¯';
                    break;
                case 4: // Ù…Ù†Ø·Ù‚Ø© ØµÙ†Ø§Ø¹ÙŠØ©
                    zoneColor = '#7c3aed';
                    zoneTheme = 'ØµÙ†Ø§Ø¹ÙŠØ©';
                    break;
            }
            
            // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù†Ø·Ù‚Ø©
            showZoneInfo(zone, zoneTheme);
            
            // Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©
            Game.walls.push({x: -zoneSize/2, y: -zoneSize/2, w: zoneSize, h: 50, color: zoneColor});
            Game.walls.push({x: -zoneSize/2, y: zoneSize/2 - 50, w: zoneSize, h: 50, color: zoneColor});
            Game.walls.push({x: -zoneSize/2, y: -zoneSize/2, w: 50, h: zoneSize, color: zoneColor});
            Game.walls.push({x: zoneSize/2 - 50, y: -zoneSize/2, w: 50, h: zoneSize, color: zoneColor});

            // Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ù…Ù†Ø·Ù‚Ø© (Ù†Ù‚Ø§Ø· ØªÙˆØ¬ÙŠÙ‡)
            const markerCount = 8 + zone;
            for(let i = 0; i < markerCount; i++) {
                const angle = (i / markerCount) * Math.PI * 2;
                const dist = zoneSize/2 - 100;
                Game.zoneMarkers.push({
                    x: Math.cos(angle) * dist,
                    y: Math.sin(angle) * dist,
                    size: 30,
                    color: zoneColor
                });
            }

            // Ø¬Ø¯Ø±Ø§Ù† Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
            const wallCount = 25 + zone * 3;
            for(let i = 0; i < wallCount; i++) {
                const w = Math.random() * 100 + 80;
                const h = Math.random() * 100 + 80;
                const x = (Math.random() - 0.5) * (zoneSize - 300);
                const y = (Math.random() - 0.5) * (zoneSize - 300);
                if(Math.hypot(x, y) > 300) {
                    Game.walls.push({x, y, w, h, color: '#374151'});
                }
            }

            // ØºØ·Ø§Ø¡ (Ø¹Ø´Ø¨/Ø£Ø´Ø¬Ø§Ø±/ØµØ®ÙˆØ±)
            const coverCount = 30 + zone * 4;
            for(let i = 0; i < coverCount; i++) {
                const w = Math.random() * 150 + 100;
                const h = Math.random() * 150 + 100;
                const x = (Math.random() - 0.5) * (zoneSize - 300);
                const y = (Math.random() - 0.5) * (zoneSize - 300);
                Game.grass.push({x, y, w, h, color: zoneColor + '40'});
            }

            // ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¡ Ù„Ù„Ù…Ù†Ø·Ù‚Ø©
            Game.zoneEnemies = 8 + Math.floor(zone * 2.5);
            Game.enemiesDefeated = 0;
            spawnWave(Game.currentWave, zone);

            // Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© ÙÙŠ ÙˆØ³Ø· Ø§Ù„Ù…Ù†Ø·Ù‚Ø©
            Game.portal = { 
                x: 0, 
                y: -zoneSize/2 + 200, 
                r: 45, 
                active: false,
                color: zoneColor
            };
            Game.portalOpen = false;
            
            // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ù†Ø·Ù‚Ø©
            updateZoneUI();
        }

        function spawnWave(wave, zone) {
            Game.enemies = [];
            const enemyCount = Math.min(Game.zoneEnemies - Game.enemiesDefeated, 5 + Math.floor(wave * 1.5));
            
            for(let i = 0; i < enemyCount; i++) {
                const angle = Math.random() * Math.PI * 2;
                const dist = Math.random() * 800 + 400;
                
                // Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¡ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© ÙˆØ§Ù„Ù…ÙˆØ¬Ø©
                let type = 'scout';
                let hp = 30 + zone * 8 + wave * 3;
                let speed = 2.5;
                let enemySize = 20;
                let color = '#ef4444';
                let weapon = { rate: 60, dmg: 5 + zone + wave };

                if(zone > 2 && Math.random() < 0.3) { 
                    type = 'heavy'; 
                    hp *= 1.8; 
                    speed = 1.5; 
                    enemySize = 32; 
                    color = '#8b5cf6'; 
                    weapon.dmg *= 1.5; 
                }
                if(zone > 4 && Math.random() < 0.25) { 
                    type = 'sniper'; 
                    hp *= 0.6; 
                    speed = 2; 
                    enemySize = 18; 
                    color = '#fbbf24'; 
                    weapon.rate = 120; 
                    weapon.dmg *= 2; 
                }
                if(zone > 6 && Math.random() < 0.2) { 
                    type = 'boss'; 
                    hp *= 3; 
                    speed = 1.2; 
                    enemySize = 45; 
                    color = '#dc2626'; 
                    weapon.dmg *= 2.5; 
                }

                Game.enemies.push({
                    x: Math.cos(angle) * dist, 
                    y: Math.sin(angle) * dist,
                    hp, 
                    maxHp: hp, 
                    speed, 
                    size: enemySize, 
                    color, 
                    type, 
                    weapon,
                    angle: 0, 
                    lastShot: Math.random() * 100,
                    score: 10 + zone * 2
                });
            }
        }

        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ù„Ø¹Ø¨Ø© ---
        function startGame() {
            // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
            document.getElementById('loadingOverlay').classList.add('hidden');
            
            // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø¨Ø§Ø¨Ø© ÙˆØ§Ù„ØªØ·ÙˆÙŠØ±Ø§Øª
            const tankType = TANK_TYPES[Game.data.selectedTank];
            const ups = Game.data.upgrades;
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            const baseHP = tankType.hp;
            const hpBonus = UPGRADES.health.val(ups.health);
            const totalHP = baseHP + hpBonus;
            
            const baseSpeed = tankType.speed;
            const speedBonus = UPGRADES.speed.val(ups.speed);
            const totalSpeed = baseSpeed * (1 + speedBonus);
            
            const baseDmg = tankType.damage;
            const dmgBonus = UPGRADES.damage.val(ups.damage);
            const totalDmg = baseDmg * (1 + dmgBonus);
            
            const baseRate = tankType.rate;
            const rateBonus = UPGRADES.rate.val(ups.rate);
            const totalRate = Math.max(5, baseRate * (1 - rateBonus));
            
            const rangeBonus = UPGRADES.range.val(ups.range);
            const critChance = UPGRADES.critical.val(ups.critical);

            Game.player = {
                x: 0, 
                y: 0,
                hp: totalHP, 
                maxHp: totalHP, 
                speed: totalSpeed,
                weapon: { 
                    dmg: totalDmg, 
                    rate: totalRate, 
                    lastShot: 0,
                    range: 400 * (1 + rangeBonus),
                    critChance: critChance
                },
                size: 24, 
                angle: 0,
                shieldCd: 0, 
                shielded: false,
                tankType: Game.data.selectedTank,
                regenRate: UPGRADES.regen.val(ups.regen)
            };

            // Ø§Ù„Ø­Ù„ÙØ§Ø¡
            Game.allies = [];
            for(let i = 0; i < ups.ally; i++) {
                Game.allies.push({
                    x: Math.random() * 50 - 25, 
                    y: Math.random() * 50 - 25,
                    hp: totalHP * 0.5, 
                    speed: totalSpeed * 1.1, 
                    size: 16,
                    target: null, 
                    offset: {
                        x: (Math.random() - 0.5) * 100, 
                        y: (Math.random() - 0.5) * 100
                    },
                    lastShot: 0
                });
            }

            Game.currentZone = 1;
            Game.currentWave = 1;
            Game.runGold = 0;
            Game.bullets = []; 
            Game.particles = []; 
            Game.texts = [];
            Game.gameTime = 0;
            Game.lastRegen = 0;
            
            generateZone(1);
            setScreen('GAME');
            updateHUD();
            updateZoneUI();
            Audio.init();
        }

        function loop() {
            if(Game.state !== 'GAME') {
                requestAnimationFrame(loop);
                return;
            }
            
            Game.gameTime++;
            
            updatePlayer();
            updateAllies();
            updateEnemies();
            updateBullets();
            updateLogic();
            updatePortalArrow();
            render();
            
            requestAnimationFrame(loop);
        }

        function updatePlayer() {
            const p = Game.player;
            
            // Ø§Ù„Ø­Ø±ÙƒØ©
            if(Game.input.active) {
                const len = Math.hypot(Game.input.x, Game.input.y);
                if(len > 0) {
                    p.x += (Game.input.x / len) * p.speed;
                    p.y += (Game.input.y / len) * p.speed;
                    p.angle = Math.atan2(Game.input.y, Game.input.x);
                }
            }
            resolveWallCollision(p);

            // Ø¥ØµÙ„Ø§Ø­ ØªÙ„Ù‚Ø§Ø¦ÙŠ
            if(p.regenRate > 0 && Game.gameTime - Game.lastRegen > 600) {
                const healAmount = p.maxHp * p.regenRate;
                p.hp = Math.min(p.maxHp, p.hp + healAmount);
                Game.lastRegen = Game.gameTime;
                showFloatText(p.x, p.y, `+${Math.floor(healAmount)}â¤ï¸`, '#10b981');
            }

            // Ø§Ù„Ø±Ù…Ø§ÙŠØ©
            if(p.weapon.lastShot <= 0) {
                let target = getNearestEnemy(p, p.weapon.range);
                if(target && !isHiding(target)) {
                    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¶Ø±Ø± Ù…Ø¹ ÙØ±ØµØ© Ø§Ù„Ø¶Ø±Ø¨Ø© Ø§Ù„Ø­Ø±Ø¬Ø©
                    let damage = p.weapon.dmg;
                    let isCritical = false;
                    if(Math.random() < p.weapon.critChance) {
                        damage *= 2;
                        isCritical = true;
                    }
                    
                    shoot(p, target, damage, isCritical ? '#fbbf24' : TANK_TYPES[p.tankType].color, true);
                    p.weapon.lastShot = p.weapon.rate;
                }
            }
            p.weapon.lastShot--;

            // Ù‚Ø¯Ø±Ø© Ø§Ù„Ø¯Ø±Ø¹
            if(p.shieldCd > 0) {
                p.shieldCd--;
                const pct = 100 - (p.shieldCd / 300 * 100);
                document.getElementById('abilityCd').style.height = (100 - pct) + '%';
            }
            if(p.shielded) {
                p.shielded--;
            }
        }

        function useAbility() {
            if(Game.player.shieldCd > 0) return;
            Game.player.shielded = 120;
            Game.player.shieldCd = 300;
            spawnParticles(Game.player.x, Game.player.y, '#3b82f6', 30);
            Audio.play('portal');
        }

        function updateAllies() {
            Game.allies.forEach(a => {
                // Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨
                const tx = Game.player.x + a.offset.x;
                const ty = Game.player.y + a.offset.y;
                const dx = tx - a.x; 
                const dy = ty - a.y;
                const dist = Math.hypot(dx, dy);
                
                if(dist > 50) {
                    a.x += (dx/dist) * a.speed;
                    a.y += (dy/dist) * a.speed;
                    a.angle = Math.atan2(dy, dx);
                }

                // Ø§Ù„Ø±Ù…Ø§ÙŠØ©
                if(a.lastShot <= 0) {
                    let target = getNearestEnemy(a, 350);
                    if(target) {
                        shoot(a, target, Game.player.weapon.dmg * 0.6, '#60a5fa', true);
                        a.lastShot = 40;
                    }
                }
                a.lastShot--;
            });
        }

        function updateEnemies() {
            Game.enemies.forEach(e => {
                const distToPlayer = Math.hypot(Game.player.x - e.x, Game.player.y - e.y);
                const playerHidden = isHiding(Game.player);

                // Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
                if(!playerHidden && distToPlayer < 600) {
                    const angle = Math.atan2(Game.player.y - e.y, Game.player.x - e.x);
                    e.angle = angle;
                    
                    if(distToPlayer > 150) {
                        e.x += Math.cos(angle) * e.speed;
                        e.y += Math.sin(angle) * e.speed;
                    }

                    // Ø§Ù„Ø±Ù…Ø§ÙŠØ©
                    if(e.lastShot <= 0 && distToPlayer < 400 && hasLineOfSight(e, Game.player)) {
                        shoot(e, Game.player, e.weapon.dmg, e.color, false);
                        e.lastShot = e.weapon.rate + Math.random() * 20;
                    }
                } else {
                    // Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª
                    if(Math.random() < 0.02) e.angle = Math.random() * Math.PI * 2;
                    e.x += Math.cos(e.angle) * (e.speed * 0.5);
                    e.y += Math.sin(e.angle) * (e.speed * 0.5);
                }
                
                e.lastShot--;
                resolveWallCollision(e);
            });
        }

        function updateBullets() {
            for(let i = Game.bullets.length - 1; i >= 0; i--) {
                const b = Game.bullets[i];
                b.x += b.vx; 
                b.y += b.vy; 
                b.life--;
                
                // ØªØµØ§Ø¯Ù… Ù…Ø¹ Ø§Ù„Ø¬Ø¯Ø±Ø§Ù†
                if(hitWall(b.x, b.y)) {
                    spawnParticles(b.x, b.y, '#fff', 3);
                    Game.bullets.splice(i, 1);
                    continue;
                }

                // ØªØµØ§Ø¯Ù… Ù…Ø¹ Ø§Ù„ÙƒØ§Ø¦Ù†Ø§Øª
                let hit = false;
                if(b.isPlayer) {
                    for(let e of Game.enemies) {
                        if(Math.hypot(e.x - b.x, e.y - b.y) < e.size + 5) {
                            damageEnemy(e, b.dmg, b.isCritical);
                            hit = true; 
                            break;
                        }
                    }
                } else {
                    // Ø±ØµØ§Øµ Ø§Ù„Ø¹Ø¯Ùˆ ÙŠØµÙŠØ¨ Ø§Ù„Ù„Ø§Ø¹Ø¨
                    if(Math.hypot(Game.player.x - b.x, Game.player.y - b.y) < Game.player.size + 5) {
                        if(Game.player.shielded > 0) {
                            Audio.play('hit');
                        } else {
                            Game.player.hp -= b.dmg;
                            Game.camera.shake = 5;
                            Audio.play('hit');
                            if(Game.player.hp <= 0) gameOver();
                        }
                        hit = true;
                    }
                }

                if(hit || b.life <= 0) {
                    Game.bullets.splice(i, 1);
                }
            }
        }

        function updateLogic() {
            // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©
            if(Game.enemies.length === 0 && !Game.portalOpen) {
                // Ø¥Ø°Ø§ Ù‡ÙØ²Ù…Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¡ ÙÙŠ Ø§Ù„Ù…ÙˆØ¬Ø©
                Game.enemiesDefeated += (Game.zoneEnemies - Game.enemiesDefeated > 5 ? 5 : Game.zoneEnemies - Game.enemiesDefeated);
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©
                if(Game.enemiesDefeated >= Game.zoneEnemies) {
                    Game.portalOpen = true;
                    Game.portal.active = true;
                    Audio.play('portal');
                    document.getElementById('missionStatus').classList.remove('hidden');
                    document.getElementById('zoneWarning').classList.add('hidden');
                } else {
                    // Ù…ÙˆØ¬Ø© Ø¬Ø¯ÙŠØ¯Ø©
                    Game.currentWave++;
                    setTimeout(() => {
                        spawnWave(Game.currentWave, Game.currentZone);
                    }, 2000);
                    
                    // ØªØ­Ø°ÙŠØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©
                    if(Game.enemiesDefeated >= Game.zoneEnemies * 0.7) {
                        document.getElementById('zoneWarning').classList.remove('hidden');
                    }
                }
                
                updateZoneUI();
            }

            // ØªÙØ§Ø¹Ù„ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©
            if(Game.portalOpen) {
                if(Math.hypot(Game.player.x - Game.portal.x, Game.player.y - Game.portal.y) < 60) {
                    // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
                    Game.currentZone++;
                    Game.currentWave = 1;
                    
                    // Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ù…Ù†Ø·Ù‚Ø©
                    const zoneBonus = Game.currentZone * 100;
                    Game.runGold += zoneBonus;
                    Game.player.hp = Math.min(Game.player.maxHp, Game.player.hp + Game.player.maxHp * 0.5);
                    
                    showFloatText(Game.player.x, Game.player.y, `Ù…Ù†Ø·Ù‚Ø© ${Game.currentZone}! +${zoneBonus}ğŸ’`, '#a855f7');
                    
                    document.getElementById('missionStatus').classList.add('hidden');
                    generateZone(Game.currentZone);
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ù‡Ù…
                    updatePortalArrow();
                }
            }

            updateHUD();
            updateZoneUI();
        }

        function updatePortalArrow() {
            const arrow = document.getElementById('portalArrow');
            
            if(!Game.portalOpen || !Game.portal) {
                arrow.classList.add('hidden');
                return;
            }
            
            arrow.classList.remove('hidden');
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ù†Ø­Ùˆ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©
            const dx = Game.portal.x - Game.player.x;
            const dy = Game.portal.y - Game.player.y;
            const distance = Math.hypot(dx, dy);
            const angle = Math.atan2(dy, dx);
            
            // ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ù‡Ù… ÙÙˆÙ‚ Ø§Ù„Ø¯Ø¨Ø§Ø¨Ø©
            const arrowDistance = 80;
            const screenX = W/2 + Math.cos(angle) * arrowDistance;
            const screenY = H/2 + Math.sin(angle) * arrowDistance;
            
            arrow.style.left = (screenX - 20) + 'px';
            arrow.style.top = (screenY - 40) + 'px';
            
            // ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø³Ù‡Ù…
            const rotation = angle + Math.PI / 2;
            arrow.style.transform = `rotate(${rotation}rad)`;
            
            // ØªØºÙŠÙŠØ± Ø§Ù„Ù„ÙˆÙ† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§ÙØ©
            if(distance < 300) {
                arrow.style.color = '#10b981';
                arrow.style.filter = 'drop-shadow(0 0 15px #10b981)';
            } else if(distance < 600) {
                arrow.style.color = '#fbbf24';
                arrow.style.filter = 'drop-shadow(0 0 15px #fbbf24)';
            } else {
                arrow.style.color = '#a855f7';
                arrow.style.filter = 'drop-shadow(0 0 15px #a855f7)';
            }
        }

        function updateHUD() {
            if(!Game.player) return;
            
            document.getElementById('enemiesLeft').innerText = `Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¡: ${Game.enemies.length}`;
            document.getElementById('hpBar').style.width = Math.max(0, (Game.player.hp / Game.player.maxHp * 100)) + '%';
            document.getElementById('goldDisplay').innerText = Game.runGold;
            document.getElementById('zoneDisplay').innerText = Game.currentZone;
            document.getElementById('waveDisplay').innerText = Game.currentWave;
            document.getElementById('tankType').innerText = TANK_TYPES[Game.player.tankType].name;
        }

        function updateZoneUI() {
            const progress = Game.enemiesDefeated / Game.zoneEnemies * 100;
            document.getElementById('zoneProgress').innerText = `Ø§Ù„ØªÙ‚Ø¯Ù…: ${Math.round(progress)}%`;
            
            // ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø§Ù„ØªÙ‚Ø¯Ù…
            const progressElement = document.getElementById('zoneProgress');
            if(progress > 70) {
                progressElement.style.color = '#10b981';
            } else if(progress > 40) {
                progressElement.style.color = '#fbbf24';
            } else {
                progressElement.style.color = '#ef4444';
            }
        }

        function showZoneInfo(zone, theme) {
            const zoneText = document.createElement('div');
            zoneText.className = 'dmg-text';
            zoneText.style.color = '#a855f7';
            zoneText.style.fontSize = '2.5rem';
            zoneText.style.left = '50%';
            zoneText.style.top = '40%';
            zoneText.style.transform = 'translate(-50%, -50%)';
            zoneText.innerText = `Ø§Ù„Ù…Ù†Ø·Ù‚Ø© ${zone}: ${theme}`;
            document.body.appendChild(zoneText);
            setTimeout(() => zoneText.remove(), 3000);
        }

        // --- Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡ ÙˆØ§Ù„Ø§Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ---
        function resolveWallCollision(ent) {
            for(let w of Game.walls) {
                let cx = Math.max(w.x, Math.min(ent.x, w.x + w.w));
                let cy = Math.max(w.y, Math.min(ent.y, w.y + w.h));
                let dx = ent.x - cx;
                let dy = ent.y - cy;
                if(dx*dx + dy*dy < (ent.size * ent.size)) {
                    const angle = Math.atan2(dy, dx);
                    ent.x = cx + Math.cos(angle) * (ent.size + 1);
                    ent.y = cy + Math.sin(angle) * (ent.size + 1);
                }
            }
        }

        function hitWall(x, y) {
            for(let w of Game.walls) {
                if(x > w.x && x < w.x + w.w && y > w.y && y < w.y + w.h) return true;
            }
            return false;
        }

        function hasLineOfSight(a, b) {
            const dist = Math.hypot(b.x - a.x, b.y - a.y);
            const steps = dist / 20;
            const dx = (b.x - a.x) / steps;
            const dy = (b.y - a.y) / steps;
            for(let i = 1; i < steps - 1; i++) {
                if(hitWall(a.x + dx * i, a.y + dy * i)) return false;
            }
            return true;
        }

        function isHiding(ent) {
            for(let g of Game.grass) {
                if(ent.x > g.x && ent.x < g.x + g.w && ent.y > g.y && ent.y < g.y + g.h) return true;
            }
            return false;
        }

        function getNearestEnemy(source, range) {
            let target = null;
            let minDist = range;
            for(let e of Game.enemies) {
                const d = Math.hypot(e.x - source.x, e.y - source.y);
                if(d < minDist && hasLineOfSight(source, e)) {
                    minDist = d;
                    target = e;
                }
            }
            return target;
        }

        function shoot(source, target, dmg, color, isPlayer) {
            const angle = Math.atan2(target.y - source.y, target.x - source.x);
            const spread = (Math.random() - 0.5) * 0.1;
            Game.bullets.push({
                x: source.x, 
                y: source.y,
                vx: Math.cos(angle + spread) * 12,
                vy: Math.sin(angle + spread) * 12,
                life: 100, 
                dmg, 
                color, 
                isPlayer,
                isCritical: color === '#fbbf24'
            });
            if(isPlayer) Audio.play('shoot');
        }

        function damageEnemy(e, amt, isCritical) {
            e.hp -= amt;
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ø¶Ø±Ø±
            const damageColor = isCritical ? '#fbbf24' : '#fff';
            const damageText = isCritical ? `CRIT! ${Math.floor(amt)}` : Math.floor(amt);
            showFloatText(e.x, e.y, damageText, damageColor);
            
            if(e.hp <= 0) {
                const index = Game.enemies.indexOf(e);
                if(index !== -1) {
                    Game.enemies.splice(index, 1);
                    Game.enemiesDefeated++;
                    
                    // Ø¬Ø³ÙŠÙ…Ø§Øª Ø§Ù„ØªØ¯Ù…ÙŠØ±
                    spawnParticles(e.x, e.y, e.color, 15);
                    Audio.play('kill');
                    
                    // Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ø°Ù‡Ø¨
                    const goldReward = e.score || 10;
                    Game.runGold += goldReward;
                    
                    // Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©
                    if(Math.random() < 0.3 || isCritical) {
                        spawnParticles(e.x, e.y, '#fbbf24', 5);
                        showFloatText(e.x, e.y, `+${goldReward}ğŸ’`, '#fbbf24');
                    }
                }
            }
        }

        function showFloatText(x, y, txt, col) {
            const div = document.createElement('div');
            div.className = 'dmg-text';
            div.style.color = col;
            div.style.left = (W/2 + (x - Game.player.x)) + 'px';
            div.style.top = (H/2 + (y - Game.player.y)) + 'px';
            div.innerText = txt;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 800);
        }

        function spawnParticles(x, y, col, count) {
            for(let i = 0; i < count; i++) {
                Game.particles.push({
                    x, 
                    y, 
                    vx: (Math.random()-0.5)*10, 
                    vy: (Math.random()-0.5)*10,
                    life: 1, 
                    col,
                    size: Math.random() * 4 + 2
                });
            }
        }

        // --- Ø§Ù„Ø±Ø³Ù… ---
        function drawTank(x, y, angle, tankType, isShielded) {
            const tank = TANK_TYPES[tankType];
            ctx.save();
            ctx.translate(x, y);
            ctx.rotate(angle);
            
            // Ø±Ø³Ù… Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¯Ø¨Ø§Ø¨Ø© Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
            switch(tankType) {
                case 'basic':
                    // Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
                    ctx.fillStyle = tank.color;
                    ctx.fillRect(-12, -12, 24, 24);
                    // Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª
                    ctx.fillStyle = '#1e293b';
                    ctx.fillRect(-12, -15, 24, 6);
                    ctx.fillRect(-12, 9, 24, 6);
                    // Ø§Ù„Ø¨Ø±Ø¬
                    ctx.fillStyle = '#0f172a';
                    ctx.fillRect(0, -4, 25, 8);
                    break;
                    
                case 'assault':
                    // Ø¯Ø¨Ø§Ø¨Ø© Ø§Ù‚ØªØ­Ø§Ù… (Ø®ÙÙŠÙØ© ÙˆØ³Ø±ÙŠØ¹Ø©)
                    ctx.fillStyle = tank.color;
                    ctx.beginPath();
                    ctx.roundRect(-10, -10, 20, 20, 5);
                    ctx.fill();
                    // ØªÙØ§ØµÙŠÙ„
                    ctx.fillStyle = '#1e40af';
                    ctx.fillRect(-8, -12, 16, 4);
                    ctx.fillRect(-8, 8, 16, 4);
                    // Ø¨Ø±Ø¬ Ø·ÙˆÙŠÙ„
                    ctx.fillStyle = '#1e3a8a';
                    ctx.fillRect(0, -3, 30, 6);
                    break;
                    
                case 'heavy':
                    // Ø¯Ø¨Ø§Ø¨Ø© Ø«Ù‚ÙŠÙ„Ø©
                    ctx.fillStyle = tank.color;
                    ctx.fillRect(-15, -15, 30, 30);
                    // Ø¯Ø±Ø¹ Ø¥Ø¶Ø§ÙÙŠ
                    ctx.fillStyle = '#991b1b';
                    ctx.fillRect(-12, -18, 24, 6);
                    ctx.fillRect(-12, 12, 24, 6);
                    ctx.fillRect(-18, -12, 6, 24);
                    ctx.fillRect(12, -12, 6, 24);
                    // Ø¨Ø±Ø¬ Ù‚ØµÙŠØ± ÙˆØ«Ù‚ÙŠÙ„
                    ctx.fillStyle = '#000';
                    ctx.fillRect(0, -5, 20, 10);
                    break;
                    
                case 'sniper':
                    // Ø¯Ø¨Ø§Ø¨Ø© Ù‚Ù†Ø§Øµ
                    ctx.fillStyle = tank.color;
                    ctx.beginPath();
                    ctx.ellipse(0, 0, 10, 8, 0, 0, Math.PI * 2);
                    ctx.fill();
                    // Ø¨Ø±Ø¬ Ø·ÙˆÙŠÙ„ Ø¬Ø¯Ø§Ù‹
                    ctx.fillStyle = '#047857';
                    ctx.fillRect(0, -2, 35, 4);
                    // Ù…Ù†Ø¸Ø§Ø±
                    ctx.fillStyle = '#000';
                    ctx.beginPath();
                    ctx.arc(30, 0, 3, 0, Math.PI * 2);
                    ctx.fill();
                    break;
                    
                case 'tank':
                    // Ø¯Ø¨Ø§Ø¨Ø© Ø­Ø±Ø¨ÙŠØ© Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ø§Øª
                    ctx.fillStyle = tank.color;
                    ctx.beginPath();
                    ctx.roundRect(-13, -13, 26, 26, 6);
                    ctx.fill();
                    // Ù…Ø³Ø§Ø±Ø§Øª Ù…Ø²Ø¯ÙˆØ¬Ø©
                    ctx.fillStyle = '#5b21b6';
                    ctx.fillRect(-13, -16, 26, 6);
                    ctx.fillRect(-13, 10, 26, 6);
                    // Ø¨Ø±Ø¬ Ù…ØªÙˆØ³Ø·
                    ctx.fillStyle = '#4c1d95';
                    ctx.fillRect(0, -4, 22, 8);
                    break;
                    
                case 'elite':
                    // Ø¯Ø¨Ø§Ø¨Ø© Ø§Ù„Ù†Ø®Ø¨Ø©
                    const gradient = ctx.createLinearGradient(-15, -15, 15, 15);
                    gradient.addColorStop(0, '#fbbf24');
                    gradient.addColorStop(1, '#f59e0b');
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.roundRect(-14, -14, 28, 28, 7);
                    ctx.fill();
                    // ØªÙØ§ØµÙŠÙ„ Ù…ØªØ·ÙˆØ±Ø©
                    ctx.fillStyle = '#d97706';
                    ctx.fillRect(-12, -17, 24, 6);
                    ctx.fillRect(-12, 11, 24, 6);
                    // Ø¨Ø±Ø¬ Ù…Ø²Ø¯ÙˆØ¬
                    ctx.fillStyle = '#b45309';
                    ctx.fillRect(0, -5, 28, 10);
                    // Ù…Ø¯Ø§ÙØ¹ Ù…Ø²Ø¯ÙˆØ¬Ø©
                    ctx.fillStyle = '#000';
                    ctx.fillRect(28, -3, 8, 6);
                    ctx.fillRect(28, -1, 15, 2);
                    break;
            }
            
            ctx.restore();
            
            // ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¯Ø±Ø¹
            if(isShielded) {
                ctx.strokeStyle = 'rgba(96, 165, 250, 0.7)';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(x, y, Game.player.size * 1.2, 0, Math.PI * 2);
                ctx.stroke();
            }
        }

        function render() {
            // ØªØ£Ø«ÙŠØ± Ø§Ù‡ØªØ²Ø§Ø² Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
            if(Game.camera.shake > 0) {
                ctx.setTransform(1, 0, 0, 1, (Math.random()-0.5)*Game.camera.shake, (Math.random()-0.5)*Game.camera.shake);
                Game.camera.shake *= 0.9;
                if(Game.camera.shake < 0.5) Game.camera.shake = 0;
            } else { 
                ctx.setTransform(1, 0, 0, 1, 0, 0); 
            }

            // Ø§Ù„Ø®Ù„ÙÙŠØ©
            ctx.fillStyle = '#050505'; 
            ctx.fillRect(0, 0, W, H);

            const p = Game.player;
            const camX = W/2 - p.x;
            const camY = H/2 - p.y;
            ctx.translate(camX, camY);

            // Ø´Ø¨ÙƒØ© Ø§Ù„Ø£Ø±Ø¶ÙŠØ©
            ctx.strokeStyle = '#111'; 
            ctx.lineWidth = 1;
            const gs = 100;
            const sx = Math.floor((p.x - W/2)/gs)*gs;
            const sy = Math.floor((p.y - H/2)/gs)*gs;
            ctx.beginPath();
            for(let x = sx; x < sx + W + gs; x += gs) { 
                ctx.moveTo(x, p.y - H); 
                ctx.lineTo(x, p.y + H); 
            }
            for(let y = sy; y < sy + H + gs; y += gs) { 
                ctx.moveTo(p.x - W, y); 
                ctx.lineTo(p.x + W, y); 
            }
            ctx.stroke();

            // Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ù…Ù†Ø·Ù‚Ø©
            Game.zoneMarkers.forEach(marker => {
                ctx.fillStyle = marker.color + '30';
                ctx.beginPath();
                ctx.arc(marker.x, marker.y, marker.size, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.strokeStyle = marker.color;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(marker.x, marker.y, marker.size, 0, Math.PI * 2);
                ctx.stroke();
            });

            // Ø§Ù„ØºØ·Ø§Ø¡
            Game.grass.forEach(g => {
                ctx.fillStyle = g.color || '#064e3b60';
                ctx.fillRect(g.x, g.y, g.w, g.h);
            });

            // Ø§Ù„Ø¬Ø¯Ø±Ø§Ù†
            Game.walls.forEach(w => {
                ctx.fillStyle = w.color || '#0f172a'; 
                ctx.fillRect(w.x, w.y, w.w, w.h);
                ctx.strokeStyle = w.color ? w.color + '80' : '#0ea5e9'; 
                ctx.lineWidth = 2;
                ctx.strokeRect(w.x, w.y, w.w, w.h);
            });

            // Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©
            if(Game.portalOpen) {
                const portalAlpha = 0.6 + Math.sin(Date.now()*0.005)*0.2;
                ctx.fillStyle = Game.portal.color + Math.floor(portalAlpha * 255).toString(16);
                ctx.beginPath(); 
                ctx.arc(Game.portal.x, Game.portal.y, Game.portal.r, 0, Math.PI*2); 
                ctx.fill();
                
                // ØªØ£Ø«ÙŠØ± Ø¯ÙˆØ§Ù…ÙŠ
                ctx.strokeStyle = '#fff'; 
                ctx.lineWidth = 3;
                for(let i = 0; i < 3; i++) {
                    ctx.beginPath();
                    ctx.arc(Game.portal.x, Game.portal.y, Game.portal.r * (0.7 + i * 0.1), 
                           Date.now()*0.002 + i, Date.now()*0.002 + i + Math.PI * 1.5);
                    ctx.stroke();
                }
            }

            // Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¡
            Game.enemies.forEach(e => {
                const hidden = isHiding(e);
                ctx.globalAlpha = hidden ? 0.4 : 1;
                
                ctx.save();
                ctx.translate(e.x, e.y);
                ctx.rotate(e.angle);
                
                // Ø±Ø³Ù… Ø§Ù„Ø¹Ø¯Ùˆ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
                ctx.fillStyle = e.color;
                
                if(e.type === 'boss') {
                    // Ø±Ø³Ù… Ø§Ù„Ø²Ø¹ÙŠÙ…
                    ctx.fillRect(-e.size/2, -e.size/2, e.size, e.size);
                    // ØªØ§Ø¬ Ø§Ù„Ø²Ø¹ÙŠÙ…
                    ctx.fillStyle = '#fbbf24';
                    for(let i = 0; i < 3; i++) {
                        const spikeAngle = (i / 3) * Math.PI * 2;
                        ctx.beginPath();
                        ctx.moveTo(0, -e.size/2);
                        ctx.lineTo(Math.cos(spikeAngle) * 10, -e.size/2 - 15);
                        ctx.lineTo(Math.cos(spikeAngle + 0.5) * 10, -e.size/2);
                        ctx.fill();
                    }
                } else {
                    // Ø±Ø³Ù… Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¡ Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ†
                    ctx.fillRect(-e.size/2, -e.size/2, e.size, e.size);
                }
                
                // Ø¨Ø±Ø¬ Ø§Ù„Ø¹Ø¯Ùˆ
                ctx.fillStyle = '#000'; 
                ctx.fillRect(0, -2, e.size * 0.8, 4);
                
                ctx.restore();
                
                // Ø´Ø±ÙŠØ· Ø§Ù„ØµØ­Ø©
                if(e.hp < e.maxHp) {
                    const barWidth = e.size * 2;
                    const barHeight = 4;
                    const barX = e.x - barWidth/2;
                    const barY = e.y - e.size - 8;
                    
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                    ctx.fillRect(barX, barY, barWidth, barHeight);
                    
                    ctx.fillStyle = e.hp > e.maxHp * 0.5 ? '#10b981' : 
                                   e.hp > e.maxHp * 0.25 ? '#fbbf24' : '#ef4444';
                    ctx.fillRect(barX, barY, barWidth * (e.hp / e.maxHp), barHeight);
                }
                
                ctx.globalAlpha = 1;
            });

            // Ø§Ù„Ø­Ù„ÙØ§Ø¡
            Game.allies.forEach(a => {
                ctx.save(); 
                ctx.translate(a.x, a.y); 
                ctx.rotate(a.angle);
                // Ø±Ø³Ù… Ø§Ù„Ø­Ù„ÙŠÙ ÙƒØ¯Ø±ÙˆÙ†
                ctx.fillStyle = '#60a5fa'; 
                ctx.beginPath();
                ctx.arc(0, 0, a.size/2, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = '#fff'; 
                ctx.fillRect(0, -1, 10, 2);
                ctx.restore();
            });

            // Ø§Ù„Ù„Ø§Ø¹Ø¨ (Ø§Ù„Ø¯Ø¨Ø§Ø¨Ø©)
            const pHidden = isHiding(p);
            ctx.globalAlpha = pHidden ? 0.6 : 1;
            
            drawTank(p.x, p.y, p.angle, p.tankType, p.shielded > 0);
            
            ctx.globalAlpha = 1;

            // Ø§Ù„Ø±ØµØ§Øµ
            Game.bullets.forEach(b => {
                ctx.fillStyle = b.color;
                if(b.isCritical) {
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = b.color;
                }
                ctx.beginPath(); 
                ctx.arc(b.x, b.y, b.isCritical ? 6 : 4, 0, Math.PI*2); 
                ctx.fill();
                ctx.shadowBlur = 0;
            });

            // Ø§Ù„Ø¬Ø³ÙŠÙ…Ø§Øª
            for(let i = Game.particles.length - 1; i >= 0; i--) {
                const pt = Game.particles[i];
                pt.x += pt.vx; 
                pt.y += pt.vy; 
                pt.life -= 0.05;
                ctx.globalAlpha = pt.life; 
                ctx.fillStyle = pt.col;
                ctx.fillRect(pt.x, pt.y, pt.size || 4, pt.size || 4);
                if(pt.life <= 0) {
                    Game.particles.splice(i, 1);
                }
            }
            ctx.globalAlpha = 1;

            ctx.setTransform(1, 0, 0, 1, 0, 0);
        }

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„ ---
        function saveGame() {
            localStorage.setItem('panzer_zone_save', JSON.stringify(Game.data));
        }
        
        function loadGame() {
            const saved = localStorage.getItem('panzer_zone_save');
            if(saved) {
                try {
                    const loadedData = JSON.parse(saved);
                    Game.data = { ...Game.data, ...loadedData };
                    
                    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ·ÙˆÙŠØ±Ø§Øª
                    Object.keys(UPGRADES).forEach(key => {
                        if(!Game.data.upgrades[key]) {
                            Game.data.upgrades[key] = 0;
                        }
                    });
                    
                    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¯Ø¨Ø§Ø¨Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                    if(!Game.data.unlockedTanks) Game.data.unlockedTanks = ['basic'];
                    if(!Game.data.selectedTank) Game.data.selectedTank = 'basic';
                    
                } catch (e) {
                    console.log("Error loading save:", e);
                }
            }
            updateMenuUI();
            loadTankSelection();
        }

        function updateMenuUI() {
            document.getElementById('menuGold').innerText = Game.data.gold;
        }

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø¨Ø§Ø¨Ø§Øª ---
        function loadTankSelection() {
            const selection = document.getElementById('tankSelection');
            selection.innerHTML = '';
            
            Object.entries(TANK_TYPES).forEach(([key, tank]) => {
                const isUnlocked = Game.data.unlockedTanks.includes(key);
                const isSelected = Game.data.selectedTank === key;
                
                const card = document.createElement('div');
                card.className = `tank-card p-3 rounded-lg text-center ${isSelected ? 'selected' : ''} ${isUnlocked ? 'cursor-pointer' : 'opacity-50'}`;
                card.style.backgroundColor = tank.color + '20';
                card.style.borderColor = isSelected ? tank.color : 'transparent';
                
                card.innerHTML = `
                    <div class="text-lg font-bold text-white mb-1">${tank.name}</div>
                    <div class="text-xs text-gray-300 mb-2">${tank.desc}</div>
                    ${!isUnlocked ? `<div class="text-yellow-400 text-sm mb-2">${tank.cost} ğŸ’</div>` : ''}
                    <div class="flex justify-center mb-2">
                        <div class="w-8 h-8 rounded" style="background-color: ${tank.color}"></div>
                    </div>
                    <div class="text-xs text-gray-400">${tank.special}</div>
                `;
                
                if(isUnlocked) {
                    card.onclick = () => {
                        Game.data.selectedTank = key;
                        saveGame();
                        loadTankSelection();
                    };
                } else {
                    card.onclick = () => {
                        if(Game.data.gold >= tank.cost) {
                            Game.data.gold -= tank.cost;
                            Game.data.unlockedTanks.push(key);
                            Game.data.selectedTank = key;
                            saveGame();
                            loadTankSelection();
                            updateMenuUI();
                            Audio.play('upgrade');
                        }
                    };
                }
                
                selection.appendChild(card);
            });
        }

        function renderTankShop() {
            const list = document.getElementById('tankList');
            list.innerHTML = '';
            document.getElementById('tankGoldDisplay').innerText = Game.data.gold + " ğŸ’";
            
            Object.entries(TANK_TYPES).forEach(([key, tank]) => {
                const isUnlocked = Game.data.unlockedTanks.includes(key);
                const isSelected = Game.data.selectedTank === key;
                
                const div = document.createElement('div');
                div.className = "glass-panel p-4 rounded-xl";
                div.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 rounded-lg flex items-center justify-center" style="background-color: ${tank.color}20; border: 2px solid ${tank.color}">
                            <div class="w-10 h-10 rounded" style="background-color: ${tank.color}"></div>
                        </div>
                        <div class="flex-1">
                            <div class="font-bold text-white text-lg flex items-center gap-2">
                                ${tank.name}
                                ${isSelected ? '<span class="text-xs bg-green-600 px-2 py-1 rounded">Ù…Ø®ØªØ§Ø±Ø©</span>' : ''}
                                ${isUnlocked ? '<span class="text-xs bg-blue-600 px-2 py-1 rounded">Ù…ÙØªÙˆØ­Ø©</span>' : ''}
                            </div>
                            <div class="text-gray-300 text-sm mt-1">${tank.desc}</div>
                            <div class="flex gap-4 mt-2 text-xs">
                                <div class="text-cyan-400">â¤ï¸ ${tank.hp}</div>
                                <div class="text-red-400">âš”ï¸ ${tank.damage}</div>
                                <div class="text-blue-400">âš¡ ${tank.speed}</div>
                                <div class="text-yellow-400">ğŸ¯ ${tank.rate}</div>
                            </div>
                            <div class="text-gray-400 text-xs mt-2">${tank.special}</div>
                        </div>
                        <button class="px-4 py-2 rounded-lg font-bold text-sm ${isUnlocked ? (isSelected ? 'bg-gray-700 text-gray-500' : 'bg-blue-600 text-white cursor-pointer') : (Game.data.gold>=tank.cost ? 'bg-yellow-600 text-black cursor-pointer' : 'bg-gray-700 text-gray-500')}">
                            ${isUnlocked ? (isSelected ? 'Ù…Ø®ØªØ§Ø±Ø©' : 'Ø§Ø®ØªØ±') : tank.cost + 'ğŸ’'}
                        </button>
                    </div>
                `;
                
                if(isUnlocked && !isSelected) {
                    div.querySelector('button').onclick = () => {
                        Game.data.selectedTank = key;
                        saveGame();
                        renderTankShop();
                    };
                } else if(!isUnlocked) {
                    if(Game.data.gold >= tank.cost) {
                        div.querySelector('button').onclick = () => {
                            Game.data.gold -= tank.cost;
                            Game.data.unlockedTanks.push(key);
                            Game.data.selectedTank = key;
                            saveGame();
                            renderTankShop();
                            updateMenuUI();
                            Audio.play('upgrade');
                        };
                    }
                }
                
                list.appendChild(div);
            });
        }

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ·ÙˆÙŠØ±Ø§Øª ---
        function renderShop() {
            const list = document.getElementById('shopList');
            list.innerHTML = '';
            document.getElementById('shopGoldDisplay').innerText = Game.data.gold + " ğŸ’";
            
            Object.keys(UPGRADES).forEach(k => {
                const u = UPGRADES[k];
                const lvl = Game.data.upgrades[k] || 0;
                const cost = u.cost(lvl);
                const isMax = lvl >= u.max;
                
                const div = document.createElement('div');
                div.className = "glass-panel p-4 rounded-xl flex justify-between items-center";
                div.innerHTML = `
                    <div>
                        <div class="font-bold text-white text-lg">${u.name} <span class="text-xs ${u.category === 'attack' ? 'text-red-400' : u.category === 'defense' ? 'text-green-400' : u.category === 'mobility' ? 'text-blue-400' : 'text-yellow-400'}">Lv.${lvl}</span></div>
                        <div class="text-gray-400 text-xs">${u.desc}</div>
                    </div>
                    <button class="px-4 py-2 rounded-lg font-bold text-sm ${Game.data.gold>=cost && !isMax ? 'bg-yellow-600 text-black cursor-pointer' : 'bg-gray-700 text-gray-500'}">
                        ${isMax ? 'MAX' : cost + 'ğŸ’'}
                    </button>
                `;
                
                if(Game.data.gold >= cost && !isMax) {
                    div.querySelector('button').onclick = () => {
                        Game.data.gold -= cost;
                        Game.data.upgrades[k] = lvl + 1;
                        saveGame();
                        Audio.play('coin');
                        renderShop();
                        updateMenuUI();
                    };
                }
                list.appendChild(div);
            });
        }

        // --- ÙˆØ§Ø¬Ù‡Ø§Øª Ø§Ù„Ø´Ø§Ø´Ø§Øª ---
        function setScreen(s) {
            Game.state = s;
            document.querySelectorAll('.game-ui').forEach(el => el.classList.add('hidden'));
            document.getElementById('hud').classList.add('hidden');
            
            if(s === 'MENU') { 
                document.getElementById('mainMenu').classList.remove('hidden'); 
                updateMenuUI(); 
                loadTankSelection();
            }
            if(s === 'GAME') {
                document.getElementById('hud').classList.remove('hidden');
            }
            if(s === 'SHOP') {
                document.getElementById('shopScreen').classList.remove('hidden');
            }
            if(s === 'TANKS') {
                document.getElementById('tankScreen').classList.remove('hidden');
            }
            if(s === 'GAMEOVER') {
                document.getElementById('gameOverScreen').classList.remove('hidden');
            }
        }

        function gameOver() {
            setScreen('GAMEOVER');
            Game.data.gold += Game.runGold;
            saveGame();
            document.getElementById('endZone').innerText = Game.currentZone;
            document.getElementById('endGold').innerText = Game.runGold;
        }

        function resize() { 
            W = canvas.width = window.innerWidth; 
            H = canvas.height = window.innerHeight; 
        }

        // --- ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© ---
        window.onload = () => {
            console.log("Game loading...");
            
            // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ±
            setTimeout(() => {
                document.getElementById('loadingOverlay').classList.add('hidden');
            }, 1000);
            
            resize(); 
            window.addEventListener('resize', resize);
            
            loadGame();
            
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
            document.getElementById('btnStart').onclick = startGame;
            document.getElementById('btnUpgrade').onclick = () => { 
                setScreen('SHOP'); 
                renderShop(); 
            };
            document.getElementById('btnTanks').onclick = () => { 
                setScreen('TANKS'); 
                renderTankShop(); 
            };
            document.getElementById('btnAllies').onclick = () => { 
                setScreen('SHOP'); 
                renderShop(); 
            };
            document.getElementById('btnBackToMenu').onclick = () => setScreen('MENU');
            document.getElementById('btnBackToMenuFromTanks').onclick = () => setScreen('MENU');
            document.getElementById('btnRestart').onclick = startGame;
            document.getElementById('btnToMenu').onclick = () => setScreen('MENU');
            document.getElementById('abilityBtn').onclick = useAbility;
            document.getElementById('btnReset').onclick = () => { 
                localStorage.clear(); 
                location.reload(); 
            };
            
            // Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù„Ù…Ø³
            let isDragging = false;
            
            canvas.addEventListener('pointerdown', (e) => {
                if(Game.state !== 'GAME') return;
                isDragging = true;
                Game.input.active = true;
                Game.input.px = e.clientX;
                Game.input.py = e.clientY;
                Audio.init();
            });
            
            window.addEventListener('pointermove', (e) => {
                if(!isDragging || !Game.input.active) return;
                
                const dx = e.clientX - Game.input.px;
                const dy = e.clientY - Game.input.py;
                const dist = Math.min(60, Math.hypot(dx, dy));
                const angle = Math.atan2(dy, dx);
                
                Game.input.x = Math.cos(angle) * dist;
                Game.input.y = Math.sin(angle) * dist;
                
                // ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù„Ø­Ø±ÙƒØ© Ø³Ù„Ø³Ø©
                Game.input.px = e.clientX;
                Game.input.py = e.clientY;
            });
            
            window.addEventListener('pointerup', () => {
                isDragging = false;
                Game.input.active = false;
                Game.input.x = 0;
                Game.input.y = 0;
            });
            
            // Ø¨Ø¯Ø¡ Ø­Ù„Ù‚Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
            requestAnimationFrame(loop);
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            setScreen('MENU');
            console.log("Game initialized successfully!");
        };

        // Ø¬Ø¹Ù„ Ø§Ù„Ø¯ÙˆØ§Ù„ Ù…ØªØ§Ø­Ø© Ù„Ù„Ù†Ø§ÙØ°Ø© Ù„Ù„ØªØµØ­ÙŠØ­
        window.Game = Game;
        window.setScreen = setScreen;
        window.startGame = startGame;
    </script>
</body>
</html>